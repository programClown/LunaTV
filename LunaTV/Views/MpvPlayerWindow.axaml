<u:UrsaWindow
    x:Class="LunaTV.Views.MpvPlayerWindow"
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:fa="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:mpv="clr-namespace:HanumanInstitute.LibMpv.Avalonia;assembly=Luna.LibMpv.Avalonia"
    xmlns:tvShowPages="clr-namespace:LunaTV.ViewModels.TVShowPages"
    xmlns:u="https://irihi.tech/ursa"
    xmlns:vm="using:LunaTV.ViewModels"
    xmlns:utils="using:LunaTV.Utils"
    Title="LunaTV"
    d:DesignHeight="450"
    d:DesignWidth="1000"
    x:DataType="vm:MpvPlayerWindowModel"
    Icon="/Assets/logo-tv.png"
    IsFullScreenButtonVisible="True"
    WindowStartupLocation="CenterScreen"
    WindowState="Maximized"
    PointerEntered="OnPointerEntered"
    PointerMoved="OnPointerMoved"
    mc:Ignorable="d">
    <Window.KeyBindings>
        <KeyBinding Gesture="Space" Command="{Binding  PlayPause}" />
        <KeyBinding Gesture="Right" Command="{Binding Seek}" CommandParameter="{utils:Int32 1}" />
        <KeyBinding Gesture="Ctrl+Right" Command="{Binding Seek}"
                    CommandParameter="{utils:Int32 10}" />
        <KeyBinding Gesture="Left" Command="{Binding Seek}" CommandParameter="{utils:Int32 -1}" />
        <KeyBinding Gesture="Ctrl+Left" Command="{Binding Seek}"
                    CommandParameter="{utils:Int32 -10}" />
        <KeyBinding Gesture="Up" Command="{Binding ChangeVolume}"
                    CommandParameter="{utils:Int32 5}" />
        <KeyBinding Gesture="Down" Command="{Binding ChangeVolume}"
                    CommandParameter="{utils:Int32 -5}" />
    </Window.KeyBindings>

    <Window.Styles>
        <Style Selector="fa|SymbolIcon.PlayIcon">
            <Setter Property="Symbol" Value="PlayFilled" />
        </Style>
        <Style Selector="fa|SymbolIcon.PauseIcon">
            <Setter Property="Symbol" Value="PauseFilled" />
        </Style>

        <Style Selector="fa|SymbolIcon.MuteIcon">
            <Setter Property="Symbol" Value="Speaker2Filled" />
        </Style>
        <Style Selector="fa|SymbolIcon.UnmuteIcon">
            <Setter Property="Symbol" Value="SpeakerOffFilled" />
        </Style>

        <Style Selector="Button.TransparentButton:pointerover">
            <Style Selector="^ /template/ ContentPresenter#PART_ContentPresenter">
                <Setter Property="Background" Value="Transparent" />
            </Style>
            <Setter Property="RenderTransform" Value="scale(1.01,1.01)" />
        </Style>
        <Style Selector="Button.TransparentButton:pressed">
            <Style Selector="^ /template/ ContentPresenter#PART_ContentPresenter">
                <Setter Property="Background" Value="Transparent" />
            </Style>
        </Style>
    </Window.Styles>

    <Grid RowDefinitions="Auto,*">
        <TextBlock
            Margin="0,8"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Text="{Binding Title, Mode=OneWay}" />
        <Grid Grid.Row="1" ColumnDefinitions="*,Auto">
            <Panel>
                <mpv:MpvView MpvContext="{Binding Mpv}" Renderer="OpenGl" />

                <!--  Bottom Toolbar  -->
                <Border
                    Name="PlayBar"
                    Margin="0,0,0,8"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Bottom"
                    ZIndex="2">
                    <Grid RowDefinitions="Auto,Auto">

                        <!--  Seek Slider  -->
                        <Slider
                            Name="PART_SeekBar"
                            Margin="10,0"
                            VerticalAlignment="Center"
                            Focusable="False"
                            IsHitTestVisible="True"
                            LargeChange="10"
                            Maximum="{Binding Duration, Converter={StaticResource TimeSpanToDoubleConverter}, Mode=OneWay}"
                            Minimum="0"
                            SmallChange="1"
                            Value="{Binding Position, Converter={StaticResource TimeSpanToDoubleConverter}}" />

                        <Grid Grid.Row="1" ColumnDefinitions="*,*,*">
                            <StackPanel
                                Grid.Column="0"
                                Margin="40,0"
                                Orientation="Horizontal"
                                Spacing="4">
                                <!--  Current Position Display  -->
                                <TextBlock VerticalAlignment="Center"
                                           Text="{Binding Position, Converter={StaticResource TimeSpanToMinutesSecondsConverter}}" />
                                <TextBlock VerticalAlignment="Center" Text="/" />
                                <!--  Maximum Duration Display  -->
                                <TextBlock VerticalAlignment="Center"
                                           Text="{Binding Duration, Converter={StaticResource TimeSpanToMinutesSecondsConverter}}" />
                            </StackPanel>
                            <StackPanel
                                Grid.Column="1"
                                HorizontalAlignment="Center"
                                Orientation="Horizontal">
                                <Button
                                    Command="{Binding Stop}"
                                    Theme="{DynamicResource BorderlessButton}"
                                    ToolTip.Tip="结束">
                                    <fa:SymbolIcon FontSize="18" Symbol="StopFilled" />
                                </Button>
                                <Button
                                    Command="{Binding GoHeadCommand}"
                                    Theme="{DynamicResource BorderlessButton}"
                                    ToolTip.Tip="移到开头">
                                    <fa:SymbolIcon FontSize="18" Symbol="PreviousFilled" />
                                </Button>
                                <Button
                                    Command="{Binding PlayPause}"
                                    Theme="{DynamicResource BorderlessButton}"
                                    ToolTip.Tip="播放/暂停">
                                    <fa:SymbolIcon
                                        Classes.PauseIcon="{Binding IsPlaying}"
                                        Classes.PlayIcon="{Binding !IsPlaying}"
                                        FontSize="32" />
                                </Button>
                                <Button
                                    Command="{Binding GoTailCommand}"
                                    Theme="{DynamicResource BorderlessButton}"
                                    ToolTip.Tip="移到结尾">
                                    <fa:SymbolIcon FontSize="18" Symbol="NextFilled" />
                                </Button>
                            </StackPanel>

                            <StackPanel
                                Grid.Column="2"
                                Margin="10,0"
                                HorizontalAlignment="Right"
                                Orientation="Horizontal">
                                <Button
                                    Padding="2"
                                    Command="{Binding ScreenshotCommand}"
                                    Theme="{DynamicResource BorderlessButton}"
                                    ToolTip.Tip="截屏">
                                    <fa:SymbolIcon FontSize="18" Symbol="Camera" />
                                </Button>
                                <Button
                                    Margin="10,0"
                                    Padding="2"
                                    Background="Transparent"
                                    Command="{Binding MuteCommand}">
                                    <fa:SymbolIcon
                                        Classes.MuteIcon="{Binding !IsMuted}"
                                        Classes.UnmuteIcon="{Binding IsMuted}"
                                        FontSize="18" />
                                </Button>
                                <Slider
                                    Width="150"
                                    Margin="0,0,20,0"
                                    VerticalAlignment="Center"
                                    Focusable="False"
                                    LargeChange="20"
                                    Maximum="100"
                                    SmallChange="5"
                                    Value="{Binding Volume}" />
                                <TextBlock
                                    Width="30"
                                    Margin="-16,0,8,0"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Center"
                                    Text="{Binding Volume, StringFormat={}{0:N0}}" />
                                <TextBlock VerticalAlignment="Center" Text="倍速" />
                                <Button
                                    Classes="TransparentButton Tertiary"
                                    Content="{Binding SpeedText}"
                                    Theme="{DynamicResource BorderlessButton}">
                                    <Button.Flyout>
                                        <MenuFlyout ItemsSource="{Binding SpeedMenuItems}" Placement="Top" />
                                    </Button.Flyout>
                                    <Button.Styles>
                                        <Style x:DataType="vm:SpeedMenuItemViewModel" Selector="MenuItem">
                                            <Setter Property="Header" Value="{Binding Header}" />
                                            <Setter Property="Command" Value="{Binding Command}" />
                                            <Setter Property="CommandParameter" Value="{Binding CommandParameter}" />
                                        </Style>
                                    </Button.Styles>
                                </Button>
                                <ToggleButton
                                    Margin="4,0,0,0"
                                    Background="Transparent"
                                    Classes="Tertiary"
                                    IsChecked="{Binding IsVideosKanbanChecked}">
                                    <PathIcon Data="{DynamicResource SemiIconKanban}" FontSize="10" />
                                </ToggleButton>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>
            </Panel>

            <Border Grid.Column="1"
                    Width="{Binding KanBanWidth}">
                <Grid RowDefinitions="Auto,*">
                    <TextBlock
                        HorizontalAlignment="Left"
                        VerticalAlignment="Center"
                        FontSize="18"
                        FontWeight="ExtraBold"
                        IsHitTestVisible="False"
                        Text="{Binding Title}">
                        <TextBlock.Foreground>
                            <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
                                <GradientStop Offset="0" Color="#FF6094EA" />
                                <GradientStop Offset="1" Color="#FFF02FC2" />
                            </LinearGradientBrush>
                        </TextBlock.Foreground>
                        <TextBlock.Effect>
                            <DropShadowEffect Opacity="0.1" Color="Black" />
                        </TextBlock.Effect>
                    </TextBlock>

                    <ScrollViewer Grid.Row="1" Margin="4">
                        <ItemsControl HorizontalAlignment="Left" ItemsSource="{Binding Episodes}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="tvShowPages:EpisodeSubjectItem">

                                    <Button
                                        Width="100"
                                        Margin="0,4"
                                        Padding="0"
                                        Classes="EpisodeCard"
                                        Command="{Binding $parent[u:UrsaWindow].((vm:MpvPlayerWindowModel)DataContext).KanbanSelectCommand}"
                                        CommandParameter="{Binding}">
                                        <Button.Styles>
                                            <Style Selector="Button.EpisodeCard:pointerover">
                                                <Setter Property="RenderTransform" Value="scale(1.05,1.05)" />
                                            </Style>
                                        </Button.Styles>
                                        <TextBlock Classes.Warning="{Binding Watched}" Text="{Binding Name}">
                                            <TextBlock.Styles>
                                                <Style Selector="TextBlock.Warning">
                                                    <Setter Property="ToolTip.Tip" Value="已经看过" />
                                                </Style>
                                            </TextBlock.Styles>
                                        </TextBlock>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel ItemSpacing="8" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>
    </Grid>

</u:UrsaWindow>